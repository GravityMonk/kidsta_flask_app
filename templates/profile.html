<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>My Profile - KIDSTA APP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        * { box-sizing: border-box; }
        html,body { height:100%; }
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 0;
            color: #111827;
            -webkit-font-smoothing:antialiased;
        }
        .topbar {
            background: #2563eb;
            color: white;
            padding: 12px 16px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
        }
        .topbar .brand { font-weight:700; font-size:16px; }
        .topbar nav a { color: white; text-decoration:none; margin-left:12px; font-size:14px; }

        .wrapper {
            max-width: 840px;
            margin: 18px auto;
            padding: 0 14px;
        }

        .profile-header {
            display:flex;
            gap:16px;
            align-items:flex-start;
            background: white;
            border-radius:14px;
            padding:18px;
            border:1px solid #e6e9ee;
        }

        .avatar-wrap {
            width:120px;
            min-width:120px;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:10px;
        }
        .avatar {
            width:120px;
            height:120px;
            border-radius:50%;
            overflow:hidden;
            background:#e2e8f0;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:42px;
            color:#475569;
            box-shadow: 0 6px 18px rgba(16,24,40,0.06);
            border: 4px solid #fff;
        }
        .avatar img { width:100%; height:100%; object-fit:cover; display:block; }

        .profile-details {
            flex:1;
            display:flex;
            flex-direction:column;
            gap:6px;
        }
        .display-name {
            font-size:20px;
            font-weight:700;
        }
        .profile-meta { color:#6b7280; font-size:13px; }
        .profile-stats {
            display:flex;
            gap:12px;
            margin-top:8px;
            align-items:center;
            flex-wrap:wrap;
        }
        .stat {
            background:#f8fafc;
            padding:8px 10px;
            border-radius:999px;
            font-size:13px;
            border:1px solid #eef2f7;
        }

        .profile-actions {
            margin-top:12px;
            display:flex;
            gap:10px;
            align-items:center;
        }
        .btn {
            padding:8px 12px;
            border-radius:10px;
            border:none;
            cursor:pointer;
            font-size:14px;
        }
        .btn-primary { background:#2563eb; color:white; }
        .btn-outline { background:white; border:1px solid #e5e7eb; color:#111827; }

        .friends-area {
            margin-top:14px;
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap:12px;
        }
        .card {
            background:white;
            border-radius:12px;
            padding:10px;
            border:1px solid #e8eef6;
        }
        .card h4 { margin:0 0 8px 0; font-size:15px; }
        .friend-item {
            display:flex;
            gap:10px;
            align-items:center;
            padding:8px 2px;
            border-radius:8px;
        }
        .friend-avatar {
            width:44px;
            height:44px;
            border-radius:50%;
            overflow:hidden;
            background:#f1f5f9;
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:600;
            color:#334155;
        }
        .friend-name { font-size:14px; font-weight:600; }
        .friend-sub { font-size:12px; color:#6b7280; }

        .tabs { margin-top:16px; display:flex; gap:8px; }
        .tab {
            padding:8px 12px;
            border-radius:999px;
            background:#fff;
            border:1px solid #e6e9ee;
            cursor:pointer;
            font-size:14px;
        }
        .tab.active { background:#2563eb; color:white; border-color:#2563eb; }

        .posts-list { margin-top:12px; display:grid; grid-template-columns: repeat(1,1fr); gap:12px; }
        .post-card { background:white; border-radius:12px; padding:10px; border:1px solid #e6e9ee; }
        .post-meta { font-size:12px; color:#6b7280; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; gap:8px; }
        .post-caption { font-size:14px; margin:8px 0; color:#111827; }

       .post-media {
    width:100%;
    height:400px; /* square look */
    border-radius:12px;
    overflow:hidden;
    background:#111827;
    display:flex;
    align-items:center;
    justify-content:center;
}

        .post-media img, .post-media video { width:100%; height:100%; object-fit:cover; display:block; }

        .post-actions { margin-top:8px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
        .post-actions .left a { color:#2563eb; text-decoration:none; font-size:13px; }
        .post-actions .right a, .post-actions .right button { font-size:13px; text-decoration:none; border:none; background:transparent; color:#374151; cursor:pointer; }
        .danger { color:#dc2626; }

        @media (max-width:720px) {
            .friends-area { grid-template-columns:1fr; }
            .profile-header { flex-direction:column; align-items:center; text-align:center; gap:12px; }
            .avatar-wrap { width:100%; display:flex; flex-direction:row; gap:14px; align-items:center; justify-content:center; }
            .profile-details { align-items:center; }
            .post-media { height:220px; }
        }

        /* Edit modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.35);
            z-index: 1200;
        }
        .modal {
            width: 94%;
            max-width: 560px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }
        .modal h3 { margin:0 0 8px 0; font-size:18px; }
        .form-row { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
        .form-row label { font-size:13px; color:#374151; }
        .form-row input[type="text"], .form-row input[type="file"] {
            padding:8px 10px;
            border-radius:8px;
            border:1px solid #e6e9ee;
            font-size:14px;
        }
        .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
        .btn-muted { background:#f1f5f9; color:#111827; border:1px solid #e6e9ee; }
        .small-note { font-size:12px; color:#6b7280; margin-top:6px; }
    </style>
</head>
<body>

    <div class="topbar">
        <div class="brand">KIDSTA APP</div>
        <nav>
            <a href="/home">Home</a>
            <a href="/upload">New Post</a>
            <a href="/friend_requests">Requests ({{ pending_requests or 0 }})</a>
            <a href="#" onclick="openLogoutModal(); return false;">Logout</a>
        </nav>
    </div>

    <main class="wrapper" role="main">
        <!-- Profile header -->
        <section class="profile-header" aria-label="Profile header">
            <div class="avatar-wrap">
                <div class="avatar" id="avatar-circle" aria-hidden="true">
                    {% if user.avatar_filename %}
                        <img id="avatar-img" src="{{ url_for('uploaded_file', filename=user.avatar_filename) }}" alt="{{ user.display_name or user.username }}'s profile picture">
                    {% else %}
                        <span id="avatar-initials">{{ (user.display_name or user.username)[:2] | upper }}</span>
                    {% endif %}
                </div>

                <div style="display:flex; flex-direction:column; gap:6px; align-items:center;">
                    <button class="btn btn-outline" onclick="openEditModal()">Edit profile</button>
                </div>
            </div>

            <div class="profile-details">
                <div class="display-name">{{ user.display_name or user.username }}</div>
                <div class="profile-meta">@{{ user.kidsta_id or 'no_id' }} Â· Joined {{ user.created_at or '' }}</div>

                

                <div class="profile-actions">
                    {% if current_user and current_user.id != user.id %}
                        {% if is_following %}
                            <form action="/unfollow/{{ user.id }}" method="post" style="display:inline;">
                                <button class="btn btn-outline">Unfollow</button>
                            </form>
                        {% else %}
                            <form action="/follow/{{ user.id }}" method="post" style="display:inline;">
                                <button class="btn btn-primary">Follow</button>
                            </form>
                        {% endif %}
                    {% else %}
                        <!-- local edit button shown above avatar too -->
                        <a href="javascript:void(0);" onclick="openEditModal()" class="btn btn-outline">Edit profile</a>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Friends / other sections remain unchanged (you can keep earlier content) -->
        <section class="friends-area" aria-label="Friend requests and outgoing requests">
            <div class="card" aria-labelledby="incoming-requests-title">
                <h4 id="incoming-requests-title">Incoming Requests ({{ incoming_requests|length if incoming_requests is defined else 0 }})</h4>
                {% if incoming_requests is defined and incoming_requests|length == 0 %}
                    <div style="color:#6b7280; font-size:13px;">No incoming requests</div>
                {% else %}
                    {% for req in incoming_requests %}
                        <div class="friend-item" role="article">
                            <div class="friend-avatar">
                                {% if req.from_user.avatar_filename %}
                                    <img src="{{ url_for('uploaded_file', filename=req.from_user.avatar_filename) }}" alt="{{ req.from_user.display_name or req.from_user.username }}">
                                {% else %}
                                    {{ (req.from_user.display_name or req.from_user.username)[:2] | upper }}
                                {% endif %}
                            </div>
                            <div>
                                <div class="friend-name">{{ req.from_user.display_name or req.from_user.username }}</div>
                                <div class="friend-sub">@{{ req.from_user.kidsta_id or '' }}</div>
                            </div>
                            <div class="friend-actions">
                                <form action="/friend/{{ req.id }}/accept" method="post" style="display:inline;">
                                    <button class="btn btn-primary" type="submit">Accept</button>
                                </form>
                                <form action="/friend/{{ req.id }}/reject" method="post" style="display:inline;" onsubmit="return confirm('Reject request?');">
                                    <button class="btn" type="submit">Reject</button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="card" aria-labelledby="outgoing-requests-title">
                <h4 id="outgoing-requests-title">Requests You Sent ({{ outgoing_requests|length if outgoing_requests is defined else 0 }})</h4>

                {% if outgoing_requests is defined and outgoing_requests|length == 0 %}
                    <div style="color:#6b7280; font-size:13px;">You haven't sent any requests</div>
                {% else %}
                    {% for req in outgoing_requests %}
                        <div class="friend-item">
                            <div class="friend-avatar">
                                {% if req.to_user.avatar_filename %}
                                    <img src="{{ url_for('uploaded_file', filename=req.to_user.avatar_filename) }}" alt="{{ req.to_user.display_name or req.to_user.username }}">
                                {% else %}
                                    {{ (req.to_user.display_name or req.to_user.username)[:2] | upper }}
                                {% endif %}
                            </div>
                            <div>
                                <div class="friend-name">{{ req.to_user.display_name or req.to_user.username }}</div>
                                <div class="friend-sub">@{{ req.to_user.kidsta_id or '' }} Â· {{ req.status }}</div>
                            </div>
                            <div class="friend-actions">
                                {% if req.status == 'pending' %}
                                    <form action="/cancel_request/{{ req.id }}" method="post" style="display:inline;">
                                        <button type="submit" class="btn">Cancel</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </section>

        <!-- Tabs & posts -->
        <div class="tabs" role="tablist" aria-label="Posts and reels">
            <button class="tab active" id="tab-posts" onclick="showTab('posts')">Posts ({{ posts|length }})</button>
            <button class="tab" id="tab-reels" onclick="showTab('reels')">Reels ({{ reels|length if reels is defined else 0 }})</button>
        </div>

        <section id="posts" class="posts-list" aria-live="polite">
            {% if posts|length == 0 %}
                <div style="padding:14px; background:white; border-radius:12px; border:1px solid #e6e9ee;">You have no posts yet. Create one to share with your followers.</div>
            {% endif %}
            {% for p in posts %}
                <article class="post-card" aria-labelledby="post-{{p.id}}">
                    <div class="post-meta">
                        <div id="post-{{p.id}}">Posted {{ p.created_at }}</div>
                        <div style="font-size:12px; color:#6b7280;">Visibility: {{ p.visibility }}</div>
                    </div>
                    {% if p.caption %}
                        <div class="post-caption">{{ p.caption }}</div>
                    {% endif %}
                    {% if p.media_filename %}
                        {% set filename = p.media_filename %}
                        {% set ext = filename.rsplit('.',1)[-1].lower() if '.' in filename else '' %}
                        <div class="post-media">
                            {% if ext in ['png','jpg','jpeg','gif','webp'] %}
                                <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="Post image">
                            {% elif ext in ['mp4','mov','webm'] %}
                                <video controls playsinline>
                                    <source src="{{ url_for('uploaded_file', filename=filename) }}">
                                </video>
                            {% elif ext in ['mp3','wav','m4a','ogg'] %}
                                <audio controls style="width:90%;">
                                    <source src="{{ url_for('uploaded_file', filename=filename) }}">
                                </audio>
                            {% elif ext == 'pdf' %}
                                <a class="pdf-link" href="{{ url_for('uploaded_file', filename=filename) }}" target="_blank">ðŸ“„ Open PDF</a>
                            {% else %}
                                <a class="pdf-link" href="{{ url_for('uploaded_file', filename=filename) }}" target="_blank">Download file</a>
                            {% endif %}
                        </div>
                    {% endif %}
                    <div class="post-actions">
                        <div class="left">
                            <a href="/post/{{ p.id }}/comments">Comments ({{ p.comments_count or 0 }})</a>
                        </div>
                        <div class="right">
                            <a href="/edit_post/{{ p.id }}">Edit</a>
                            &nbsp;|&nbsp;
                            <form action="/delete_post/{{ p.id }}" method="post" style="display:inline;" onsubmit="return confirm('Delete this post?');">
                                <button type="submit" class="danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </article>
            {% endfor %}
        </section>
    </main>

    <!-- Edit profile modal (inline) -->
    <div id="edit-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal" role="document">
            <h3>Edit profile</h3>
            <!-- Important: form posts to /edit_profile (server must implement save) -->
            <form id="edit-profile-form" action="/edit_profile" method="post" enctype="multipart/form-data">
                <div class="form-row">
                    <label for="display_name">Profile name</label>
                    <input id="display_name" name="display_name" type="text" value="{{ user.display_name or '' }}" placeholder="Full name">
                </div>

                <div class="form-row">
                    <label for="kidsta_id">KIDSTA ID</label>
                    <input id="kidsta_id" name="kidsta_id" type="text" value="{{ user.kidsta_id or '' }}" placeholder="unique_kidsta_id">
                    <div class="small-note">Choose a unique KIDSTA ID. No spaces.</div>
                </div>

                <div class="form-row">
                    <label for="avatar_file">Profile picture</label>
                    <input id="avatar_file" name="avatar_file" type="file" accept="image/*" onchange="previewAvatar(event)">
                    <div class="small-note">Choose an image (png/jpg/webp). Preview appears above.</div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-muted" onclick="closeEditModal()">Back</button>
                    <button id="save-btn" type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logout modal -->
    <div id="logout-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center; z-index:1200;">
        <div style="background:#fff; border-radius:12px; padding:16px; max-width:360px; margin:18px auto; box-shadow:0 12px 30px rgba(0,0,0,0.15); text-align:center;">
            <h3 style="margin:0 0 6px;">Log out?</h3>
            <p style="margin:0 0 14px; color:#374151;">Are you sure you want to log out from KIDSTA APP?</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-outline" onclick="closeLogoutModal()">Cancel</button>
                <button class="btn btn-primary" onclick="location.href='/logout'">Log out</button>
            </div>
        </div>
    </div>

<script>
    // Tabs switch
    function showTab(name) {
        document.getElementById('posts').style.display = name === 'posts' ? 'grid' : 'none';
        document.getElementById('reels') && (document.getElementById('reels').style.display = name === 'reels' ? 'grid' : 'none');
        document.getElementById('tab-posts').classList.toggle('active', name === 'posts');
        document.getElementById('tab-reels') && document.getElementById('tab-reels').classList.toggle('active', name === 'reels');
        document.getElementById('posts').setAttribute('aria-hidden', name !== 'posts');
        if (document.getElementById('reels')) document.getElementById('reels').setAttribute('aria-hidden', name !== 'reels');
    }

    function openLogoutModal() { document.getElementById('logout-modal').style.display = 'flex'; }
    function closeLogoutModal() { document.getElementById('logout-modal').style.display = 'none'; }

    // Edit modal controls
    function openEditModal() {
        const m = document.getElementById('edit-modal');
        m.style.display = 'flex';
        m.setAttribute('aria-hidden', 'false');
        // focus first input for keyboard
        setTimeout(()=>document.getElementById('display_name').focus(), 120);
    }
    function closeEditModal() {
        const m = document.getElementById('edit-modal');
        m.style.display = 'none';
        m.setAttribute('aria-hidden', 'true');
    }

    // avatar preview when file chosen in modal
    function previewAvatar(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { alert('Please pick an image file.'); return; }
        const reader = new FileReader();
        reader.onload = function(ev) {
            const avatar = document.getElementById('avatar-circle');
            let img = document.getElementById('avatar-img');
            const initials = document.getElementById('avatar-initials');
            if (initials) initials.style.display = 'none';
            if (img) {
                img.src = ev.target.result;
            } else {
                img = document.createElement('img');
                img.id = 'avatar-img';
                img.src = ev.target.result;
                img.alt = "{{ user.display_name or user.username }}";
                avatar.appendChild(img);
            }
        };
        reader.readAsDataURL(file);
    }

    // client-side validation and disable double-submit
    document.getElementById('edit-profile-form').addEventListener('submit', function(e){
        const display = document.getElementById('display_name').value.trim();
        const kid = document.getElementById('kidsta_id').value.trim();
        if (!display || !kid) {
            e.preventDefault();
            alert('Please enter both Profile name and KIDSTA ID.');
            return false;
        }

        // disable save button to prevent double clicks
        const sb = document.getElementById('save-btn');
        sb.disabled = true;
        sb.innerText = 'Saving...';

        // allow normal form submit; server should handle saving and redirect
        return true;
    }, false);
</script>
</body>
</html>
